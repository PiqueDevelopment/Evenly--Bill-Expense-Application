<!DOCTYPE html>
<html>
  <head>
    <title>Add Bill Entry</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }

      label {
        display: block;
        margin: 10px 0 5px;
      }

      input, select, button {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        box-sizing: border-box;
      }

      .optional-note {
        font-size: 0.9em;
        color: gray;
      }

      .members {
        margin-bottom: 20px;
      }

      .payer {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Add Bill Entry</h1>
    <form id="billForm">
      <label for="description">Description:</label>
      <input type="text" id="description" name="description" required>

      <label for="date">Date:</label>
      <input type="date" id="date" name="date" required>

      <label for="amount">Total Amount:</label>
      <input type="number" id="amount" name="amount" step="0.01" required>

      <label for="splitType">Split Type:</label>
      <select id="splitType" name="splitType" required>
        <option value="percentage">Percentage</option>
        <option value="amount">Fixed Amount</option>
      </select>

      <div class="payer">
        <label for="payer">Who Paid:</label>
        <input type="text" id="payer" name="payer" required>
        <p class="optional-note">(You can list multiple payers separated by commas)</p>
      </div>

      <div class="members">
        <h2>Members</h2>
        <div id="memberFields">
          <label for="memberName">Member Name:</label>
          <input type="text" name="memberName" required>

          <label for="memberSplit">Member Split:</label>
          <input type="number" name="memberSplit" step="0.01" required onchange="updateSplit()">
        </div>
        <button type="button" onclick="addMember()">Add Another Member</button>
      </div>

      <label for="uploadedFiles">Upload Documents (optional):</label>
      <input type="file" name="uploadedFiles" id="uploadedFiles" multiple>
      <p class="optional-note">(You can upload multiple files for this bill)</p>

      <button type="button" onclick="submitForm()">Submit</button>
    </form>

      <script>
        let totalAmount = 0; // This will store the total amount from the form
        let splitType = 'percentage'; // Default split type

        // Update the total amount whenever the user changes it
        document.getElementById('amount').addEventListener('input', function() {
          totalAmount = parseFloat(this.value);
          calculateRemainingSplit();
        });

        // Update the split type and recalculate when the user changes it
        document.getElementById('splitType').addEventListener('change', function() {
          splitType = this.value;
          resetMemberSplits();
        });

        function addMember() {
          const memberFields = document.getElementById('memberFields');
          const memberHTML = 
            `<label for="memberName">Member Name:</label>
            <input type="text" name="memberName" required>
            
            <label for="memberSplit">Member Split:</label>
            <input type="number" name="memberSplit" step="0.01" required onchange="updateSplit()">`;
          const div = document.createElement('div');
          div.innerHTML = memberHTML;
          memberFields.appendChild(div);
          calculateRemainingSplit();
        }

        // Recalculate the remaining split (either amount or percentage)
        function calculateRemainingSplit() {
          const splits = document.querySelectorAll('input[name="memberSplit"]');
          const totalInputs = splits.length;

          // If the split type is percentage, make sure the sum of all percentages equals 100
          if (splitType === 'percentage') {
            let totalSplit = 0;
            splits.forEach((input, index) => {
              if (index === totalInputs - 1) {
                input.value = (100 - totalSplit).toFixed(2); // Ensure the last member gets the remainder
              }
              totalSplit += parseFloat(input.value) || 0;
            });
          }
          // If the split type is fixed amount, make sure the total equals the total amount
          else if (splitType === 'amount') {
            let totalAmountSplit = 0;
            splits.forEach((input, index) => {
              if (index === totalInputs - 1) {
                input.value = (totalAmount - totalAmountSplit).toFixed(2); // Ensure the last member gets the remainder
              }
              totalAmountSplit += parseFloat(input.value) || 0;
            });
          }
        }

        // Function to update splits when one is modified
        function updateSplit() {
          const splits = document.querySelectorAll('input[name="memberSplit"]');
          const totalInputs = splits.length;

          if (splitType === 'percentage') {
            let totalSplit = 0;
            splits.forEach((input, index) => {
              if (input.value === '') return; // Skip empty inputs

              const currentSplit = parseFloat(input.value);
              totalSplit += currentSplit;

              // If totalSplit exceeds 100%, show an error
              if (totalSplit > 100) {
                input.setCustomValidity('The total percentage cannot exceed 100%.');
              } else {
                input.setCustomValidity('');
              }

              // If it's the last member, set the value to ensure the total is 100%
              if (index === totalInputs - 1) {
                const remainingPercentage = 100 - totalSplit + currentSplit;
                if (remainingPercentage >= 0) {
                  input.value = remainingPercentage.toFixed(2);
                }
              }
            });
          }

          // Handle fixed amount splits
          if (splitType === 'amount') {
            let totalAmountSplit = 0;
            splits.forEach((input, index) => {
              if (input.value === '') return;

              const currentAmount = parseFloat(input.value);
              totalAmountSplit += currentAmount;

              // If totalAmountSplit exceeds totalAmount, show an error
              if (totalAmountSplit > totalAmount) {
                input.setCustomValidity('The total amount cannot exceed the total specified.');
              } else {
                input.setCustomValidity('');
              }

              // If it's the last member, set the value to ensure the total matches the total amount
              if (index === totalInputs - 1) {
                const remainingAmount = totalAmount - totalAmountSplit + currentAmount;
                if (remainingAmount >= 0) {
                  input.value = remainingAmount.toFixed(2);
                }
              }
            });
          }
        }

        // Reset member splits if the split type changes
        function resetMemberSplits() {
          const splits = document.querySelectorAll('input[name="memberSplit"]');
          splits.forEach(input => {
            input.value = ''; // Reset all the member splits
          });
          calculateRemainingSplit();
        }

        function submitForm() {
          const form = document.getElementById("billForm");
          const formData = new FormData(form);

          const data = {
            description: formData.get('description'),
            date: formData.get('date'),
            amount: parseFloat(formData.get('amount')),
            payers: formData.get('payer').split(',').map(payer => payer.trim()), // Multiple payers
            splitType: formData.get('splitType'),
            members: [],
            uploadedFiles: []
          };

          // Collect member details
          formData.getAll('memberName').forEach((name, i) => {
            data.members.push({
              name: name,
              split: parseFloat(formData.getAll('memberSplit')[i])
            });
          });

          // Collect uploaded files
          const uploadedFiles = document.getElementById("uploadedFiles").files;
          for (let file of uploadedFiles) {
            const reader = new FileReader();
            reader.onload = function(e) {
              data.uploadedFiles.push({
                name: file.name,
                mimeType: file.type,
                data: e.target.result.split(',')[1] // Base64 encoded data
              });
            };
            reader.readAsDataURL(file);
          }

          // Wait for file processing, then submit
          setTimeout(() => {
            google.script.run.addBillToSheet(data);
            google.script.host.close();
          }, 1000);
        }
      </script>
  </body>
</html>
